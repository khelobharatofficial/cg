<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chhattisgarh Map Data Visualiser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- D3 & TopoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:#f4f6fb;margin:0;color:#111;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1200px;margin:18px auto;padding:16px}
    .layout{display:grid;grid-template-columns:minmax(260px,360px) 1fr;gap:16px}
    @media (max-width:900px){.layout{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(10,20,50,0.06)}
    h1{margin:0 0 8px;font-size:28px}
    label{display:block;font-weight:600;margin:8px 0 4px;font-size:0.95rem}
    input[type="text"],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d1d7e0;font-size:0.95rem}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .row select{flex:1}
    .row input[type="color"]{width:44px;height:34px;padding:0;border:none}
    button{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700}
    button.secondary{background:#0f766e;margin-left:6px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .small{font-size:0.82rem;color:#666;margin-top:6px}
    #map-wrap{background:#f8fafc;border-radius:8px;padding:8px;border:1px solid #e6eef6}
    #map-area{min-height:520px;border-radius:6px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center}
    svg{width:100%;height:auto;display:block}
    #data-box{margin-top:10px;padding:10px;border-radius:8px;background:#f1f5f9;border:1px solid #e2e8f0}
    footer{margin-top:18px;text-align:center;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <h1>Chhattisgarh Map Data Visualiser</h1>
    <p class="small">Select districts, pick colours, add a data title & description, then export as PNG or PDF.</p>

    <div class="layout">
      <!-- Left controls -->
      <div class="card">
        <label for="mapTitle">Map title</label>
        <input id="mapTitle" type="text" placeholder="e.g. Health Centres by District" />

        <label for="numDistricts">Number of districts to colour</label>
        <select id="numDistricts">
          <option value="0">0</option>
          <!-- offer up to number of districts (user can change) -->
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
          <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
        </select>
        <div class="small">Only chosen districts will be coloured — others stay white by default.</div>

        <div id="district-selectors" style="margin-top:10px"></div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <label for="dataTitle">Title of data</label>
        <input id="dataTitle" type="text" placeholder="e.g. Vaccination Rate (2025)" />

        <label for="dataDescription">Data description</label>
        <textarea id="dataDescription" placeholder="Short description that will appear below the map..."></textarea>

        <div style="margin-top:10px">
          <button id="generateBtn">Generate Map</button>
          <span id="status" class="small" style="margin-left:10px"></span>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7" />

        <div>
          <button id="downloadPng" class="secondary" disabled>Download PNG</button>
          <button id="downloadPdf" class="secondary" disabled>Download PDF</button>
          <div class="small" style="margin-top:6px">Export buttons enable after generating the map.</div>
        </div>
      </div>

      <!-- Right preview -->
      <div class="card">
        <div id="map-wrap">
          <div id="map-area">
            <span class="small">Map will appear here after you click Generate Map.</span>
          </div>
          <div id="data-box">
            <h3 id="dataTitleDisplay">Data title will appear here</h3>
            <p id="dataDescriptionDisplay">Data description will appear here after generation.</p>
          </div>
        </div>
      </div>
    </div>

    <footer>© 2025 <strong>Khelo Bharat Officials</strong>.</footer>
  </div>

  <script>
    // Globals
    let topo = null;
    let features = [];
    let districtNames = [];
    const objectKey = "districts"; // as in chhattisgarh.json (object is named "districts")
    const nameProp = "district";   // property that contains district name in chhattisgarh.json

    const statusEl = document.getElementById("status");

    // Load the uploaded TopoJSON
    fetch("chhattisgarh.json")
      .then(r => {
        if (!r.ok) throw new Error("Failed to load chhattisgarh.json — make sure it's in the same folder.");
        return r.json();
      })
      .then(t => {
        topo = t;
        if (!t.objects || !t.objects[objectKey]) {
          throw new Error("chhattisgarh.json doesn't contain an object named 'districts'.");
        }
        // convert to GeoJSON features
        const geo = topojson.feature(t, t.objects[objectKey]);
        features = geo.features || [];
        // collect district names (property 'district')
        const set = new Set();
        features.forEach(f => {
          const nm = (f.properties && f.properties[nameProp]) || f.id || "Unknown";
          set.add(nm);
        });
        districtNames = Array.from(set).sort((a,b)=>a.localeCompare(b));
        buildSelectors(0); // initialize
        statusEl.textContent = `Loaded ${districtNames.length} districts.`;
      })
      .catch(err => {
        console.error(err);
        statusEl.textContent = err.message;
      });

    // Create the selectors area for chosen number
    function buildSelectors(count){
      const container = document.getElementById("district-selectors");
      container.innerHTML = "";
      for(let i=0;i<count;i++){
        const row = document.createElement("div");
        row.className = "row";
        const label = document.createElement("div");
        label.style.minWidth="70px";
        label.style.fontWeight="600";
        label.style.fontSize="0.9rem";
        label.textContent = `District ${i+1}:`;
        const sel = document.createElement("select");
        sel.className = "district-select";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "-- select district --";
        sel.appendChild(defaultOpt);
        districtNames.forEach(n=>{
          const o = document.createElement("option");
          o.value = n; o.textContent = n;
          sel.appendChild(o);
        });
        const color = document.createElement("input");
        color.type = "color";
        color.className = "district-color";
        color.value = "#3b82f6";
        row.appendChild(label);
        row.appendChild(sel);
        row.appendChild(color);
        container.appendChild(row);
      }
    }

    document.getElementById("numDistricts").addEventListener("change", e=>{
      const c = parseInt(e.target.value) || 0;
      buildSelectors(c);
    });

    function getMapping(){
      const mapping = {};
      const sels = document.querySelectorAll(".district-select");
      const cols = document.querySelectorAll(".district-color");
      sels.forEach((s,i)=>{
        const name = s.value;
        const color = (cols[i] && cols[i].value) || "#000000";
        if(name) mapping[name] = color;
      });
      return mapping;
    }

    function featureName(f){
      return (f.properties && f.properties[nameProp]) || f.id || "Unknown";
    }

    // Draw the map
    function draw(){
      if(!features.length){ alert("TopoJSON not loaded yet."); return; }

      const mapTitle = document.getElementById("mapTitle").value.trim();
      const dataTitle = document.getElementById("dataTitle").value.trim();
      const dataDescription = document.getElementById("dataDescription").value.trim();
      document.getElementById("dataTitleDisplay").textContent = dataTitle || "No data title given";
      document.getElementById("dataDescriptionDisplay").textContent = dataDescription || "No data description provided.";

      const mapping = getMapping();

      const wrap = d3.select("#map-area");
      wrap.selectAll("*").remove();

      const width = 820;
      const height = 700;
      const svg = wrap.append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio","xMidYMid meet");

      // top title
      if(mapTitle){
        svg.append("text")
          .attr("x", width/2)
          .attr("y", 30)
          .attr("text-anchor","middle")
          .attr("font-size",20)
          .attr("font-weight",700)
          .text(mapTitle);
      }

      const g = svg.append("g")
        .attr("transform", mapTitle ? "translate(0,44)" : "translate(0,10)");

      // projection fit to all district features
      const projection = d3.geoMercator()
        .fitSize([width, height - 60], { type:"FeatureCollection", features });

      const path = d3.geoPath().projection(projection);

      // Fill each district (no stroke to hide inner micro-seams)
      g.selectAll("path.district")
        .data(features)
        .join("path")
        .attr("class","district")
        .attr("d", path)
        .attr("fill", d => {
          const nm = featureName(d);
          return mapping[nm] || "#ffffff"; // white by default
        })
        .attr("stroke","none");

      // Draw outer state boundary (coast/outline) - arcs where a === b
      if(topo && topo.objects && topo.objects[objectKey]){
        const obj = topo.objects[objectKey];

        const outer = topojson.mesh(topo, obj, (a,b) => a === b);
        g.append("path")
          .attr("d", path(outer))
          .attr("fill","none")
          .attr("stroke","#0f1724")
          .attr("stroke-width",1.1);

        // internal district borders (where neighboring features differ)
        const internal = topojson.mesh(topo, obj, (a,b) =>
          a !== b && a.properties && b.properties && a.properties[nameProp] !== b.properties[nameProp]
        );
        g.append("path")
          .attr("d", path(internal))
          .attr("fill","none")
          .attr("stroke","#0f1724")
          .attr("stroke-width",0.6);
      }

      // enable exports
      document.getElementById("downloadPng").disabled = false;
      document.getElementById("downloadPdf").disabled = false;
      statusEl.textContent = "Map generated.";
    }

    document.getElementById("generateBtn").addEventListener("click", draw);

    // Export helpers
    async function downloadPNG(){
      const area = document.getElementById("map-wrap");
      const canvas = await html2canvas(area, {scale:2});
      const link = document.createElement("a");
      link.download = "chhattisgarh-map.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }
    async function downloadPDF(){
      const area = document.getElementById("map-wrap");
      const canvas = await html2canvas(area, {scale:2});
      const img = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(img);
      const pdfW = pageW - 12;
      const pdfH = imgProps.height * pdfW / imgProps.width;
      const y = Math.max((pageH - pdfH)/2, 8);
      pdf.addImage(img,"PNG",6,y,pdfW,pdfH);
      pdf.save("chhattisgarh-map.pdf");
    }

    document.getElementById("downloadPng").addEventListener("click", downloadPNG);
    document.getElementById("downloadPdf").addEventListener("click", downloadPDF);
  </script>
</body>
</html>
